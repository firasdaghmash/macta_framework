<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BPMN Editor + Simulation + Viewer Demo</title>

  <!-- Layout styles -->
  <style>
    :root{--box-h:640px}
    body{font-family:Arial,Helvetica,sans-serif;margin:20px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;align-items:start}
    .panel{border:1px solid #ddd;border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.06);padding:12px}
    .panel h2{margin:4px 0 10px 0;font-size:20px}
    #editor,#viewer{height:var(--box-h);border:1px solid #e5e5e5;border-radius:8px}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .toolbar button{padding:8px 12px;border:1px solid #ccc;border-radius:8px;background:#fafafa;cursor:pointer}
    .toolbar button:hover{background:#f0f0f0}
    .note{font-size:12px;color:#666;margin-top:6px}
    .legend{font-size:12px;margin-top:8px}
    .token{display:inline-block;width:10px;height:10px;border-radius:50%;background:#ff4}
    /* highlight style in the viewer */
    .bv-highlight > rect, .bv-highlight > ellipse, .bv-highlight > polygon, .bv-highlight > path {
      stroke-width: 4px !important;
    }
  </style>

  <!-- bpmn-js styles (editor) -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/diagram-js.css" />
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js@11.5.0/dist/assets/bpmn-font/css/bpmn-embedded.css" />

  <!-- token-simulation styles -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-js-token-simulation/dist/assets/css/bpmn-js-token-simulation.css" />

  <!-- bpmn-visualization styles (viewer) -->
  <link rel="stylesheet" href="https://unpkg.com/bpmn-visualization@0.38.0/dist/bpmn-visualization.min.css" />

  <!-- bpmn-js (editor) -->
  <script src="https://unpkg.com/bpmn-js@11.5.0/dist/bpmn-modeler.development.js"></script>
  <!-- token-simulation plugin (adds Play/Stop/Speed UI inside the editor) -->
  <script src="https://unpkg.com/bpmn-js-token-simulation/dist/bpmn-js-token-simulation.umd.js"></script>

  <!-- bpmn-visualization (viewer) -->
  <script src="https://unpkg.com/bpmn-visualization@0.38.0/dist/bpmn-visualization.min.js"></script>
</head>
<body>
  <h1>BPMN Editor + Token Simulation + Viewer (Embeddable Demo)</h1>

  <div class="grid">
    <!-- Left: Editor with real token simulation (plugin) -->
    <div class="panel">
      <h2>Design &amp; Simulate with <em>bpmn-js</em></h2>
      <div id="editor"></div>
      <div class="toolbar">
        <button id="btn-load-sample">Load Sample Diagram</button>
        <button id="btn-export">Export XML → Viewer</button>
      </div>
      <div class="note">Tip: Use the green ▶ button in the editor's toolbar to run the <strong>Token Simulation</strong>. Speed controls are on the right.</div>
    </div>

    <!-- Right: Viewer with execution highlighting (mock) -->
    <div class="panel">
      <h2>View &amp; Animate with <em>bpmn-visualization</em></h2>
      <div id="viewer"></div>
      <div class="toolbar">
        <button id="btn-animate">Animate Path (Mock)</button>
        <button id="btn-clear">Clear Highlights</button>
      </div>
      <div class="legend">
        <span class="token"></span> The left editor shows <strong>actual tokens</strong> moving (via plugin).<br/>
        The right viewer <strong>animates</strong> a simple path to mimic what you'd do using data from a BPM engine (Flowable/jBPM/Activiti).
      </div>
    </div>
  </div>

  <script>
    // ---------------------- Sample BPMN ----------------------
    const sampleXml = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL"
  xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
  xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
  xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
  id="Definitions_0v3x1s8" targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn:process id="Process_Sample" isExecutable="true">
    <bpmn:startEvent id="StartEvent_1" name="Start">
      <bpmn:outgoing>Flow_1</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:task id="Task_A" name="Validate Request">
      <bpmn:incoming>Flow_1</bpmn:incoming>
      <bpmn:outgoing>Flow_2</bpmn:outgoing>
    </bpmn:task>
    <bpmn:exclusiveGateway id="Gateway_1" name="Valid?">
      <bpmn:incoming>Flow_2</bpmn:incoming>
      <bpmn:outgoing>Flow_3</bpmn:outgoing>
      <bpmn:outgoing>Flow_4</bpmn:outgoing>
      <bpmn:default>Flow_3</bpmn:default>
    </bpmn:exclusiveGateway>
    <bpmn:task id="Task_B" name="Fix Data">
      <bpmn:incoming>Flow_4</bpmn:incoming>
      <bpmn:outgoing>Flow_5</bpmn:outgoing>
    </bpmn:task>
    <bpmn:task id="Task_C" name="Approve">
      <bpmn:incoming>Flow_3</bpmn:incoming>
      <bpmn:outgoing>Flow_6</bpmn:outgoing>
    </bpmn:task>
    <bpmn:endEvent id="EndEvent_1" name="Done">
      <bpmn:incoming>Flow_5</bpmn:incoming>
      <bpmn:incoming>Flow_6</bpmn:incoming>
    </bpmn:endEvent>

    <bpmn:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_A"/>
    <bpmn:sequenceFlow id="Flow_2" sourceRef="Task_A" targetRef="Gateway_1"/>
    <bpmn:sequenceFlow id="Flow_3" sourceRef="Gateway_1" targetRef="Task_C" />
    <bpmn:sequenceFlow id="Flow_4" sourceRef="Gateway_1" targetRef="Task_B" />
    <bpmn:sequenceFlow id="Flow_5" sourceRef="Task_B" targetRef="EndEvent_1"/>
    <bpmn:sequenceFlow id="Flow_6" sourceRef="Task_C" targetRef="EndEvent_1"/>
  </bpmn:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_Sample">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="140" y="180" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_A_di" bpmnElement="Task_A">
        <dc:Bounds x="220" y="160" width="120" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1_di" bpmnElement="Gateway_1" isMarkerVisible="true">
        <dc:Bounds x="380" y="175" width="50" height="50"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_B_di" bpmnElement="Task_B">
        <dc:Bounds x="470" y="80" width="120" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_C_di" bpmnElement="Task_C">
        <dc:Bounds x="470" y="240" width="120" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="640" y="180" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="176" y="198"/>
        <di:waypoint x="220" y="200"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="340" y="200"/>
        <di:waypoint x="380" y="200"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <di:waypoint x="430" y="200"/>
        <di:waypoint x="470" y="280"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_4_di" bpmnElement="Flow_4">
        <di:waypoint x="405" y="175"/>
        <di:waypoint x="530" y="160"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_5_di" bpmnElement="Flow_5">
        <di:waypoint x="590" y="120"/>
        <di:waypoint x="658" y="198"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_6_di" bpmnElement="Flow_6">
        <di:waypoint x="590" y="280"/>
        <di:waypoint x="658" y="198"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>`;

    // ---------------------- Editor (bpmn-js) ----------------------
    // Detect the UMD global exposed by bpmn-js-token-simulation
    const tokenModule =
      window.BpmnJSTokenSimulation ||
      window.TokenSimulationModule ||
      window.bpmnjsTokenSimulation ||
      null;

    if (!tokenModule) {
      console.warn('[bpmn-js-token-simulation] module not found on window.* — the editor will load without the plugin.');
    }

    const modeler = new BpmnJS({
      container: '#editor',
      additionalModules: tokenModule ? [tokenModule] : []
    });

    // Load initial diagram
    (async () => {
      await modeler.importXML(sampleXml);
      const canvas = modeler.get('canvas');
      canvas.zoom('fit-viewport');
    })();

    // Button: Load sample
    document.getElementById('btn-load-sample').addEventListener('click', async () => {
      await modeler.importXML(sampleXml);
      modeler.get('canvas').zoom('fit-viewport');
    });

    // ---------------------- Viewer (bpmn-visualization) ----------------------
    const bpmnVisu = new BpmnVisualization({ container: 'viewer' });
    let currentXml = sampleXml;
    const registry = () => bpmnVisu.bpmnElementsRegistry;

    function loadInViewer(xml) {
      bpmnVisu.load(xml);
      // small zoom-to-fit
      bpmnVisu.navigation.fit();
    }

    // initial viewer load
    loadInViewer(sampleXml);

    // Export XML -> Viewer
    document.getElementById('btn-export').addEventListener('click', async () => {
      const { xml } = await modeler.saveXML({ format: true });
      currentXml = xml;
      loadInViewer(currentXml);
    });

    // Clear highlights in the viewer
    function clearViewerHighlights() {
      const all = registry().getElementsByKinds(['bpmn:Task', 'bpmn:StartEvent', 'bpmn:EndEvent', 'bpmn:ExclusiveGateway', 'bpmn:SequenceFlow']);
      for (const e of all) {
        registry().removeCssClasses(e.bpmnSemantic.id, ['bv-highlight']);
      }
    }
    document.getElementById('btn-clear').addEventListener('click', clearViewerHighlights);

    // ---------------------- Simple Mock Animation in Viewer ----------------------
    // Traverses the diagram by following first outgoing flow. For gateways, takes 'default' if available.
    async function animatePath(delayMs = 800) {
      // refresh xml from editor so we animate the latest state
      const { xml } = await modeler.saveXML({ format: true });
      currentXml = xml;
      loadInViewer(currentXml);

      const elementRegistry = modeler.get('elementRegistry');

      function getNextElementId(el) {
        const bo = el.businessObject;
        if (!bo) return null;

        // end event: stop
        if (bo.$type === 'bpmn:EndEvent') return null;

        // choose outgoing flow: prefer default on gateways
        let outgoing = bo.outgoing || [];
        if (bo.default) {
          const defId = bo.default.id;
          const def = outgoing.find(f => f.id === defId);
          if (def) outgoing = [def];
        }
        const flow = outgoing[0];
        if (!flow) return null;
        return flow.targetRef && flow.targetRef.id;
      }

      // find a start event
      const start = elementRegistry.filter(e => e.type === 'bpmn:StartEvent')[0];
      if (!start) return;

      clearViewerHighlights();

      // walk the graph
      let current = start;
      while (current) {
        registry().addCssClasses(current.id, ['bv-highlight']);
        await new Promise(r => setTimeout(r, delayMs));
        const nextId = getNextElementId(current);
        if (!nextId) break;
        // also highlight the sequence flow if present
        const seq = (current.businessObject.outgoing || []).find(f => f.targetRef && f.targetRef.id === nextId);
        if (seq) registry().addCssClasses(seq.id, ['bv-highlight']);
        current = elementRegistry.get(nextId);
      }
    }

    document.getElementById('btn-animate').addEventListener('click', () => animatePath(700));
  </script>
</body>
</html>
