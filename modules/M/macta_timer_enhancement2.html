<?php
// modules/M/enhanced_modeling_with_timer.php - Combined BPMN + Modeling + Timer Module

// Initialize variables
$processes = [];
$projects = [];
$db_error = '';

// Database connection
try {
    // Check if config exists
    if (file_exists('../../config/config.php')) {
        require_once '../../config/config.php';
        
        // Create PDO connection
        $dsn = "mysql:host=" . DB_HOST . ";dbname=" . DB_NAME . ";charset=utf8mb4";
        $pdo = new PDO($dsn, DB_USER, DB_PASS, [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC
        ]);
        
        // Get all processes from database
        $stmt = $pdo->prepare("
            SELECT pm.*, p.name as project_name 
            FROM process_models pm 
            LEFT JOIN projects p ON pm.project_id = p.id 
            ORDER BY pm.updated_at DESC
        ");
        $stmt->execute();
        $processes = $stmt->fetchAll();
        
        // Get all projects for dropdown
        $stmt = $pdo->prepare("SELECT * FROM projects WHERE status = 'active' ORDER BY name");
        $stmt->execute();
        $projects = $stmt->fetchAll();
        
    } else {
        $db_error = 'Database configuration not found. Please run the installer first.';
    }
    
} catch (Exception $e) {
    $db_error = "Database connection failed: " . $e->getMessage();
    error_log("BPMN Manager DB Error: " . $e->getMessage());
}

// Handle AJAX requests
if ($_SERVER['REQUEST_METHOD'] === 'POST' && isset($_POST['action'])) {
    header('Content-Type: application/json');
    
    if (!empty($db_error)) {
        echo json_encode(['success' => false, 'message' => $db_error]);
        exit;
    }
    
    switch ($_POST['action']) {
        case 'save_process':
            try {
                $stmt = $pdo->prepare("
                    INSERT INTO process_models (name, description, model_data, project_id) 
                    VALUES (?, ?, ?, ?) 
                    ON DUPLICATE KEY UPDATE 
                    model_data = VALUES(model_data), 
                    updated_at = CURRENT_TIMESTAMP
                ");
                $stmt->execute([
                    $_POST['name'] ?? 'Untitled Process',
                    $_POST['description'] ?? '',
                    $_POST['xml'] ?? '',
                    $_POST['project_id'] ?? 1
                ]);
                echo json_encode(['success' => true, 'message' => 'Process saved successfully']);
            } catch (Exception $e) {
                echo json_encode(['success' => false, 'message' => $e->getMessage()]);
            }
            exit;
            
        case 'load_process':
            try {
                $stmt = $pdo->prepare("SELECT * FROM process_models WHERE id = ?");
                $stmt->execute([$_POST['process_id'] ?? 0]);
                $process = $stmt->fetch();
                echo json_encode(['success' => true, 'process' => $process]);
            } catch (Exception $e) {
                echo json_encode(['success' => false, 'message' => $e->getMessage()]);
            }
            exit;
            
        case 'save_timer_session':
            try {
                $stmt = $pdo->prepare("
                    INSERT INTO timer_sessions (process_id, task_id, task_name, duration, start_time, end_time, completed, session_data) 
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                ");
                $stmt->execute([
                    $_POST['process_id'] ?? null,
                    $_POST['task_id'] ?? '',
                    $_POST['task_name'] ?? '',
                    $_POST['duration'] ?? 0,
                    $_POST['start_time'] ?? date('Y-m-d H:i:s'),
                    $_POST['end_time'] ?? date('Y-m-d H:i:s'),
                    $_POST['completed'] ?? 0,
                    $_POST['session_data'] ?? ''
                ]);
                echo json_encode(['success' => true, 'message' => 'Timer session saved successfully']);
            } catch (Exception $e) {
                echo json_encode(['success' => false, 'message' => $e->getMessage()]);
            }
            exit;
            
        case 'assign_resource':
            try {
                echo json_encode(['success' => true, 'message' => 'Resource assigned successfully']);
            } catch (Exception $e) {
                echo json_encode(['success' => false, 'message' => $e->getMessage()]);
            }
            exit;
    }
}
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MACTA Framework - Enhanced Modeling Module with Timer</title>

    <!-- MACTA Brand Colors and Enhanced Styling -->
    <style>
        :root {
            /* HTT Brand Colors - Updated from logo */
            --htt-blue: #1E88E5;
            --htt-dark-blue: #1565C0;
            --htt-light-blue: #42A5F5;
            --htt-gray: #666666;
            --htt-dark-gray: #424242;
            --htt-light-gray: #f5f5f5;
            
            /* MACTA Brand Colors */
            --macta-orange: #ff7b54;
            --macta-red: #d63031;
            --macta-teal: #00b894;
            --macta-yellow: #fdcb6e;
            --macta-green: #6c5ce7;
            --macta-dark: #2d3436;
            --macta-light: #ddd;
            --box-height: 600px;
            
            /* Timer Colors */
            --timer-active: #27ae60;
            --timer-paused: #f39c12;
            --timer-stopped: #e74c3c;
            --timer-completed: #8e44ad;
            
            /* Animation Color Palette - 8 distinct colors */
            --anim-color-1: #FF6B6B; /* Red */
            --anim-color-2: #4ECDC4; /* Teal */
            --anim-color-3: #45B7D1; /* Blue */
            --anim-color-4: #96CEB4; /* Green */
            --anim-color-5: #FFEAA7; /* Yellow */
            --anim-color-6: #DDA0DD; /* Purple */
            --anim-color-7: #98D8C8; /* Mint */
            --anim-color-8: #F7DC6F; /* Gold */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--htt-light-blue) 0%, var(--htt-blue) 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, var(--htt-blue) 0%, var(--htt-dark-blue) 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .macta-logo {
            width: 50px;
            height: 50px;
            background: white;
            color: var(--htt-blue);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
        }

        /* Enhanced Tab Navigation - Matching your exact design */
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid var(--macta-light);
        }

        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            transition: all 0.3s ease;
            color: var(--macta-dark);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            border-right: 1px solid var(--macta-light);
            min-height: 80px;
        }

        .nav-tab:last-child {
            border-right: none;
        }

        .nav-tab.active {
            background: white;
            color: var(--htt-blue);
            border-bottom: 3px solid var(--htt-blue);
            font-weight: bold;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(30,136,229,0.3);
        }

        .nav-tab:hover:not(.active) {
            background: #ffffff;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .tab-icon {
            font-size: 24px;
            margin-bottom: 2px;
        }

        .tab-text {
            font-size: 12px;
            text-align: center;
            line-height: 1.2;
        }

        .tab-content {
            padding: 30px;
            min-height: 70vh;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        .tab-header {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--macta-light);
        }

        .tab-header h2 {
            color: var(--macta-dark);
            font-size: 24px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tab-header p {
            color: #666;
            font-size: 14px;
        }

        /* BPMN Containers - Full width for editor */
        #bpmn-editor, #bpmn-viewer, #simulation-viewer, #timer-viewer {
            height: var(--box-height);
            border: 2px solid var(--macta-light);
            border-radius: 10px;
            background: #fafafa;
            margin-bottom: 20px;
            width: 100%;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-primary {
            background: var(--htt-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--htt-dark-blue);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(30,136,229,0.3);
        }

        .btn-secondary {
            background: var(--macta-teal);
            color: white;
        }

        .btn-secondary:hover {
            background: #00a085;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,184,148,0.3);
        }

        .btn-success {
            background: var(--macta-green);
            color: white;
        }

        .btn-success:hover {
            background: #5b4ec7;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108,92,231,0.3);
        }

        .btn-warning {
            background: var(--macta-yellow);
            color: var(--macta-dark);
        }

        .btn-warning:hover {
            background: #f0b95e;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(253,203,110,0.3);
        }

        .btn-danger {
            background: var(--macta-red);
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(214,48,49,0.3);
        }

        /* Timer Specific Styles */
        .timer-display {
            background: white;
            border: 2px solid var(--macta-light);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .timer-main {
            font-size: 48px;
            font-weight: bold;
            color: var(--htt-blue);
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }

        .timer-task {
            font-size: 18px;
            color: var(--macta-dark);
            margin-bottom: 10px;
        }

        .timer-status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .timer-status.stopped {
            background: var(--timer-stopped);
        }

        .timer-status.running {
            background: var(--timer-active);
        }

        .timer-status.paused {
            background: var(--timer-paused);
        }

        .timer-status.completed {
            background: var(--timer-completed);
        }

        .timer-history {
            background: white;
            border: 1px solid var(--macta-light);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .timer-entry {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--macta-light);
            transition: background 0.3s ease;
        }

        .timer-entry:hover {
            background: #f8f9fa;
        }

        .timer-entry:last-child {
            border-bottom: none;
        }

        .timer-task-name {
            font-weight: bold;
            color: var(--macta-dark);
        }

        .timer-duration {
            color: var(--htt-blue);
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }

        .timer-analytics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .analytics-card {
            background: white;
            border: 1px solid var(--macta-light);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .analytics-value {
            font-size: 36px;
            font-weight: bold;
            color: var(--htt-blue);
            margin: 15px 0;
        }

        .analytics-label {
            color: var(--macta-dark);
            font-weight: 500;
        }

        .analytics-change {
            font-size: 12px;
            margin-top: 5px;
        }

        .analytics-change.positive {
            color: var(--timer-active);
        }

        .analytics-change.negative {
            color: var(--timer-stopped);
        }

        /* Timer overlay for BPMN elements */
        .timer-overlay {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            font-family: 'Courier New', monospace;
        }

        .timer-overlay.running {
            background: var(--timer-active);
            animation: pulse 2s infinite;
        }

        .timer-overlay.paused {
            background: var(--timer-paused);
        }

        .timer-overlay.completed {
            background: var(--timer-completed);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Task click indicator */
        .clickable-task {
            cursor: pointer !important;
        }

        .clickable-task:hover {
            filter: brightness(1.1);
            transform: scale(1.05);
            transition: all 0.3s ease;
        }

        .status-bar {
            background: var(--htt-light-gray);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: var(--htt-gray);
            border-left: 4px solid var(--htt-blue);
        }

        .status-message {
            background: #e8f5e8;
            border: 1px solid var(--macta-green);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: var(--macta-green);
            text-align: center;
        }

        .process-selector {
            margin-bottom: 20px;
        }

        .process-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--macta-light);
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 18px;
            color: var(--macta-orange);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }

            .nav-tab {
                border-right: none !important;
                border-bottom: 1px solid var(--macta-light);
                padding: 15px;
                min-height: auto;
                flex-direction: row;
                gap: 10px;
            }

            .nav-tab:last-child {
                border-bottom: none;
            }

            .toolbar {
                flex-direction: column;
                gap: 8px;
            }

            .timer-analytics {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <!-- BPMN.js styles -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.0.0/dist/assets/diagram-js.css" />
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.0.0/dist/assets/bpmn-font/css/bpmn-embedded.css" />
</head>
<body>
    <!-- Header -->
    <div class="container">
        <div class="header">
            <h1>
                <div class="macta-logo">M</div>
                MACTA Framework - Enhanced Modeling Module with Timer
            </h1>
            <div>
                <a href="../../index.php" class="btn btn-secondary">
                    <span>←</span> Back to Framework
                </a>
            </div>
        </div>
        <div class="nav-tabs">
            <button class="nav-tab active" data-tab="bpmn-design">
                <span class="tab-icon">🎨</span>
                <span class="tab-text">BPMN Design</span>
            </button>
            <button class="nav-tab" data-tab="bpmn-view">
                <span class="tab-icon">👁️</span>
                <span class="tab-text">BPMN View</span>
            </button>
            <button class="nav-tab" data-tab="timer">
                <span class="tab-icon">⏱️</span>
                <span class="tab-text">Timer Tracking</span>
            </button>
            <button class="nav-tab" data-tab="resources">
                <span class="tab-icon">👥</span>
                <span class="tab-text">Resource Assignment</span>
            </button>
            <button class="nav-tab" data-tab="simulation">
                <span class="tab-icon">⚡</span>
                <span class="tab-text">Simulation</span>
            </button>
            <button class="nav-tab" data-tab="analysis">
                <span class="tab-icon">📊</span>
                <span class="tab-text">Path Analysis</span>
            </button>
        </div>

        <!-- BPMN Design Tab -->
        <div id="bpmn-design" class="tab-pane active">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">🎨</span>
                        BPMN Process Design & Modeling
                    </h2>
                    <p>Create and edit business process models using BPMN 2.0 standard with drag-and-drop functionality</p>
                </div>

                <!-- Process Selector -->
                <div class="process-selector">
                    <select id="process-select">
                        <option value="">Select a Process...</option>
                        <option value="new">+ Create New Process</option>
                        <?php foreach ($processes as $process): ?>
                            <option value="<?= $process['id'] ?>" data-xml="<?= htmlspecialchars($process['model_data']) ?>">
                                <?= htmlspecialchars($process['name']) ?> 
                                <?php if ($process['project_name']): ?>
                                    (<?= htmlspecialchars($process['project_name']) ?>)
                                <?php endif; ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </div>

                <!-- Enhanced Design Toolbar -->
                <div class="toolbar">
                    <button class="btn btn-primary" id="btn-new-process">
                        📄 New Process
                    </button>
                    <button class="btn btn-secondary" id="btn-save-process">
                        💾 Save Process
                    </button>
                    <button class="btn btn-warning" id="btn-clear-designer">
                        🗑️ Clear Designer
                    </button>
                    <button class="btn btn-secondary" id="btn-validate-process">
                        ✅ Validate
                    </button>
                    <button class="btn btn-secondary" id="btn-zoom-in">
                        🔍+ Zoom In
                    </button>
                    <button class="btn btn-secondary" id="btn-zoom-out">
                        🔍- Zoom Out
                    </button>
                    <button class="btn btn-secondary" id="btn-zoom-fit">
                        🔍 Fit to Screen
                    </button>
                    <button class="btn btn-success" id="btn-export-xml">
                        📤 Export to Viewer
                    </button>
                </div>

                <!-- Enhanced BPMN Editor with Full Width -->
                <div id="bpmn-editor">
                    <div class="loading">Loading Enhanced BPMN Editor...</div>
                </div>

                <div class="status-bar">
                    <span>🎯</span> Use the BPMN editor above to create professional process models.
                    <?php if (!empty($db_error)): ?>
                        <strong>Database Error:</strong> <?= htmlspecialchars($db_error) ?>
                    <?php elseif (count($processes) > 0): ?>
                        Found <?= count($processes) ?> processes in database.
                    <?php else: ?>
                        No processes found. Create your first process!
                    <?php endif; ?>
                </div>
            </div>
        </div>

        <!-- BPMN View Tab -->
        <div id="bpmn-view" class="tab-pane">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">👁️</span>
                        BPMN Process View & Animation
                    </h2>
                    <p>View and analyze saved business processes with advanced color-coded animation system</p>
                </div>

                <!-- Process Selector for Viewer -->
                <div class="process-selector">
                    <select id="viewer-process-select">
                        <option value="">Choose a process to view...</option>
                        <?php if (!empty($processes)): ?>
                            <?php foreach ($processes as $process): ?>
                                <option value="<?= $process['id'] ?>" data-xml="<?= htmlspecialchars($process['model_data']) ?>">
                                    <?= htmlspecialchars($process['name']) ?> 
                                    <?php if ($process['project_name']): ?>
                                        (<?= htmlspecialchars($process['project_name']) ?>)
                                    <?php endif; ?>
                                </option>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <option value="" disabled>No processes found in database</option>
                        <?php endif; ?>
                    </select>
                </div>

                <!-- BPMN Viewer -->
                <div id="bpmn-viewer">
                    <div class="loading">👆 Select a process from the dropdown above to view it here...</div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-primary" id="btn-animate-path">
                        🎬 Animate Process
                    </button>
                    <button class="btn btn-danger" id="btn-clear-highlights">
                        ⏹️ Stop & Clear
                    </button>
                    <button class="btn btn-warning" id="btn-analyze-bottlenecks">
                        🔍 Analyze Bottlenecks
                    </button>
                    <button class="btn btn-success" id="btn-refresh-viewer">
                        🔄 Refresh Viewer
                    </button>
                    <button class="btn btn-secondary" id="btn-viewer-zoom-fit">
                        🔍 Fit to Screen
                    </button>
                </div>
            </div>
        </div>

        <!-- Timer Tab -->
        <div id="timer" class="tab-pane">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">⏱️</span>
                        Interactive Timer Tracking
                    </h2>
                    <p>Click on any task in the process to start/pause/stop timers and track real-world execution times</p>
                </div>

                <!-- Current Timer Display -->
                <div class="timer-display">
                    <div class="timer-task" id="current-task-name">No task selected</div>
                    <div class="timer-status stopped" id="timer-status">Stopped</div>
                    <div class="timer-main" id="timer-display">00:00:00</div>
                    <div class="toolbar">
                        <button class="btn btn-success" id="btn-start-timer" disabled>
                            ▶️ Start Timer
                        </button>
                        <button class="btn btn-warning" id="btn-pause-timer" disabled>
                            ⏸️ Pause Timer
                        </button>
                        <button class="btn btn-danger" id="btn-stop-timer" disabled>
                            ⏹️ Stop Timer
                        </button>
                        <button class="btn btn-primary" id="btn-complete-task" disabled>
                            ✅ Complete Task
                        </button>
                    </div>
                </div>

                <!-- Process Selector for Timer -->
                <div class="process-selector">
                    <select id="timer-process-select">
                        <option value="">Choose a process to time...</option>
                        <?php if (!empty($processes)): ?>
                            <?php foreach ($processes as $process): ?>
                                <option value="<?= $process['id'] ?>" data-xml="<?= htmlspecialchars($process['model_data']) ?>">
                                    <?= htmlspecialchars($process['name']) ?> 
                                    <?php if ($process['project_name']): ?>
                                        (<?= htmlspecialchars($process['project_name']) ?>)
                                    <?php endif; ?>
                                </option>
                            <?php endforeach; ?>
                        <?php else: ?>
                            <option value="" disabled>No processes found in database</option>
                        <?php endif; ?>
                    </select>
                </div>

                <!-- Timer BPMN Viewer -->
                <div id="timer-viewer">
                    <div class="loading">👆 Select a process from the dropdown above and click on tasks to start timing...</div>
                </div>

                <!-- Timer Analytics -->
                <div class="timer-analytics">
                    <div class="analytics-card">
                        <div class="analytics-value" id="total-sessions">0</div>
                        <div class="analytics-label">Total Timer Sessions</div>
                        <div class="analytics-change positive" id="sessions-change">+0 today</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="avg-task-time">00:00</div>
                        <div class="analytics-label">Average Task Time</div>
                        <div class="analytics-change" id="avg-change">Based on all tasks</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="total-time-today">00:00</div>
                        <div class="analytics-label">Total Time Today</div>
                        <div class="analytics-change positive" id="today-change">Current session</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="active-timers">0</div>
                        <div class="analytics-label">Active Timers</div>
                        <div class="analytics-change" id="active-change">Running now</div>
                    </div>
                </div>

                <!-- Timer History -->
                <div class="timer-history">
                    <h3>📊 Timer History & Analytics</h3>
                    <div id="timer-entries">
                        <div style="text-align: center; color: #666; padding: 40px;">
                            No timer sessions recorded yet. Click on a task in the process above to start timing!
                        </div>
                    </div>
                </div>

                <div class="toolbar">
                    <button class="btn btn-success" id="btn-export-timer-data">
                        📤 Export Timer Data
                    </button>
                    <button class="btn btn-warning" id="btn-clear-timer-history">
                        🗑️ Clear History
                    </button>
                    <button class="btn btn-primary" id="btn-generate-time-report">
                        📊 Generate Time Report
                    </button>
                </div>
            </div>
        </div>

        <!-- Resource Assignment Tab -->
        <div id="resources" class="tab-pane">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">👥</span>
                        Advanced Resource Assignment
                    </h2>
                    <p>Assign resources, roles, and responsibilities to process steps with detailed analysis</p>
                </div>
                <div class="status-message">
                    🔧 Resource assignment functionality - enhanced with timer data integration!
                </div>
            </div>
        </div>

        <!-- Simulation Tab -->
        <div id="simulation" class="tab-pane">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">⚡</span>
                        Advanced Process Simulation
                    </h2>
                    <p>Run advanced simulations using real timer data for accurate performance analysis</p>
                </div>
                <div class="status-message">
                    ⚡ Enhanced simulation with real timer data integration - using actual timing data!
                </div>
            </div>
        </div>

        <!-- Path Analysis Tab -->
        <div id="analysis" class="tab-pane">
            <div class="tab-content">
                <div class="tab-header">
                    <h2>
                        <span class="tab-icon">📊</span>
                        Advanced Path Analysis
                    </h2>
                    <p>Comprehensive analysis of process paths using real timing data from the timer module</p>
                </div>
                <div class="status-message">
                    📊 Path analysis with real timing data integration - analyze actual performance metrics!
                </div>
            </div>
        </div>
    </div>

    <!-- BPMN.js scripts -->
    <script>
        // Store PHP data for JavaScript
        const processes = <?= json_encode($processes) ?>;
        const projects = <?= json_encode($projects) ?>;
        const dbError = <?= json_encode($db_error) ?>;
        
        // Global variables
        let modeler = null;
        let viewer = null;
        let timerViewer = null;
        let currentXML = null;
        let currentTab = 'bpmn-design';
        
        // Timer specific variables
        let currentTimer = null;
        let timerInterval = null;
        let currentTaskId = null;
        let timerSessions = [];
        let startTime = null;
        let pausedTime = 0;
        let timerOverlays = new Map();
        
        // Timer status enum
        const TimerStatus = {
            STOPPED: 'stopped',
            RUNNING: 'running',
            PAUSED: 'paused',
            COMPLETED: 'completed'
        };
        
        let currentTimerStatus = TimerStatus.STOPPED;
        
        // Default BPMN XML
        const defaultBpmnXml = `<?xml version="1.0" encoding="UTF-8"?>
<bpmn2:definitions xmlns:bpmn2="http://www.omg.org/spec/BPMN/20100524/MODEL" 
                   xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" 
                   xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" 
                   xmlns:di="http://www.omg.org/spec/DD/20100524/DI" 
                   id="sample-diagram" 
                   targetNamespace="http://bpmn.io/schema/bpmn">
  <bpmn2:process id="Process_1" isExecutable="false">
    <bpmn2:startEvent id="StartEvent_1" name="Start">
      <bpmn2:outgoing>Flow_1</bpmn2:outgoing>
    </bpmn2:startEvent>
    <bpmn2:task id="Task_1" name="Sample Task">
      <bpmn2:incoming>Flow_1</bpmn2:incoming>
      <bpmn2:outgoing>Flow_2</bpmn2:outgoing>
    </bpmn2:task>
    <bpmn2:task id="Task_2" name="Review Task">
      <bpmn2:incoming>Flow_2</bpmn2:incoming>
      <bpmn2:outgoing>Flow_3</bpmn2:outgoing>
    </bpmn2:task>
    <bpmn2:endEvent id="EndEvent_1" name="End">
      <bpmn2:incoming>Flow_3</bpmn2:incoming>
    </bpmn2:endEvent>
    <bpmn2:sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Task_1" />
    <bpmn2:sequenceFlow id="Flow_2" sourceRef="Task_1" targetRef="Task_2" />
    <bpmn2:sequenceFlow id="Flow_3" sourceRef="Task_2" targetRef="EndEvent_1" />
  </bpmn2:process>
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1">
      <bpmndi:BPMNShape id="StartEvent_1_di" bpmnElement="StartEvent_1">
        <dc:Bounds x="150" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_1_di" bpmnElement="Task_1">
        <dc:Bounds x="250" y="178" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_2_di" bpmnElement="Task_2">
        <dc:Bounds x="400" y="178" width="100" height="80"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="EndEvent_1_di" bpmnElement="EndEvent_1">
        <dc:Bounds x="550" y="200" width="36" height="36"/>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="Flow_1_di" bpmnElement="Flow_1">
        <di:waypoint x="186" y="218"/>
        <di:waypoint x="250" y="218"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_2_di" bpmnElement="Flow_2">
        <di:waypoint x="350" y="218"/>
        <di:waypoint x="400" y="218"/>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_3_di" bpmnElement="Flow_3">
        <di:waypoint x="500" y="218"/>
        <di:waypoint x="550" y="218"/>
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn2:definitions>`;

        // Enhanced Tab switching functionality
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            const targetTabButton = document.querySelector(`[data-tab="${tabName}"]`);
            if (targetTabButton) {
                targetTabButton.classList.add('active');
            }

            // Update tab content
            document.querySelectorAll('.tab-pane').forEach(content => {
                content.classList.remove('active');
            });
            const targetPane = document.getElementById(tabName);
            if (targetPane) {
                targetPane.classList.add('active');
            }

            currentTab = tabName;

            // Initialize specific tab content
            setTimeout(() => {
                if (tabName === 'bpmn-view' && viewer && currentXML) {
                    loadProcessInViewer(currentXML);
                } else if (tabName === 'timer' && timerViewer && currentXML) {
                    loadProcessInTimer(currentXML);
                }
            }, 100);
        }

        // Load scripts dynamically with fallback
        function loadScript(urls, callback) {
            let currentIndex = 0;
            
            function tryNextUrl() {
                if (currentIndex >= urls.length) {
                    console.error('All CDN sources failed');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = urls[currentIndex];
                script.onload = callback;
                script.onerror = () => {
                    console.warn('Failed to load from:', urls[currentIndex]);
                    currentIndex++;
                    tryNextUrl();
                };
                document.head.appendChild(script);
            }
            
            tryNextUrl();
        }

        // Initialize BPMN.js
        function initializeBpmn() {
            const bpmnCdnUrls = [
                'https://unpkg.com/bpmn-js@17.0.0/dist/bpmn-modeler.development.js',
                'https://cdn.jsdelivr.net/npm/bpmn-js@17.0.0/dist/bpmn-modeler.development.js',
                'https://unpkg.com/bpmn-js@16.0.0/dist/bpmn-modeler.development.js'
            ];
            
            loadScript(bpmnCdnUrls, () => {
                try {
                    if (typeof BpmnJS === 'undefined') {
                        throw new Error('BpmnJS not loaded');
                    }
                    
                    // Initialize modeler
                    modeler = new BpmnJS({
                        container: '#bpmn-editor'
                    });
                    
                    // Initialize viewer
                    viewer = new BpmnJS({
                        container: '#bpmn-viewer'
                    });
                    
                    // Initialize timer viewer
                    timerViewer = new BpmnJS({
                        container: '#timer-viewer'
                    });
                    
                    // Load initial process
                    loadInitialProcess();
                    
                    console.log('✅ Enhanced MACTA BPMN components with Timer initialized successfully');
                    
                } catch (error) {
                    console.error('Failed to initialize BPMN:', error);
                    document.querySelector('#bpmn-editor .loading').innerHTML = 'BPMN initialization failed: ' + error.message;
                }
            });
        }

        // Load initial process
        async function loadInitialProcess() {
            try {
                let xmlToLoad = defaultBpmnXml;
                
                if (processes.length > 0 && processes[0].model_data) {
                    xmlToLoad = processes[0].model_data;
                }
                
                currentXML = xmlToLoad;
                
                if (modeler) {
                    await modeler.importXML(currentXML);
                    modeler.get('canvas').zoom('fit-viewport');
                }
                
                // Hide loading indicators
                document.querySelectorAll('.loading').forEach(el => el.style.display = 'none');
                
            } catch (error) {
                console.error('Failed to load initial process:', error);
            }
        }

        // Load process in viewer
        async function loadProcessInViewer(xml) {
            if (!viewer) return;
            
            try {
                await viewer.importXML(xml);
                viewer.get('canvas').zoom('fit-viewport');
                
                const viewerLoading = document.querySelector('#bpmn-viewer .loading');
                if (viewerLoading) {
                    viewerLoading.style.display = 'none';
                }
                
            } catch (error) {
                console.error('Failed to load process in viewer:', error);
            }
        }

        // Load process in timer viewer with click handlers
        async function loadProcessInTimer(xml) {
            if (!timerViewer) return;
            
            try {
                await timerViewer.importXML(xml);
                timerViewer.get('canvas').zoom('fit-viewport');
                
                const timerLoading = document.querySelector('#timer-viewer .loading');
                if (timerLoading) {
                    timerLoading.style.display = 'none';
                }
                
                // Add click handlers to tasks
                setupTimerClickHandlers();
                
            } catch (error) {
                console.error('Failed to load process in timer viewer:', error);
            }
        }

        // Setup click handlers for timer functionality
        function setupTimerClickHandlers() {
            if (!timerViewer) return;
            
            try {
                const elementRegistry = timerViewer.get('elementRegistry');
                const eventBus = timerViewer.get('eventBus');
                
                // Get all tasks
                const tasks = elementRegistry.filter(element => 
                    element.type === 'bpmn:Task' || 
                    element.type === 'bpmn:UserTask' || 
                    element.type === 'bpmn:ServiceTask'
                );
                
                // Add click event listeners
                eventBus.on('element.click', function(event) {
                    const element = event.element;
                    
                    if (element.type === 'bpmn:Task' || 
                        element.type === 'bpmn:UserTask' || 
                        element.type === 'bpmn:ServiceTask') {
                        
                        handleTaskClick(element);
                    }
                });
                
                // Style clickable tasks
                tasks.forEach(task => {
                    const gfx = elementRegistry.getGraphics(task);
                    if (gfx) {
                        gfx.classList.add('clickable-task');
                        gfx.style.cursor = 'pointer';
                    }
                });
                
                console.log(`✅ Timer click handlers setup for ${tasks.length} tasks`);
                
            } catch (error) {
                console.error('Failed to setup timer click handlers:', error);
            }
        }

        // Handle task click for timer
        function handleTaskClick(element) {
            const taskId = element.id;
            const taskName = element.businessObject.name || element.id;
            
            console.log('Task clicked:', taskName);
            
            // If same task is clicked and timer is running, toggle pause
            if (currentTaskId === taskId && currentTimerStatus === TimerStatus.RUNNING) {
                pauseTimer();
                return;
            }
            
            // If same task is clicked and timer is paused, resume
            if (currentTaskId === taskId && currentTimerStatus === TimerStatus.PAUSED) {
                resumeTimer();
                return;
            }
            
            // If different task or no timer running, start new timer
            if (currentTimerStatus === TimerStatus.RUNNING || currentTimerStatus === TimerStatus.PAUSED) {
                stopTimer();
            }
            
            startTimerForTask(taskId, taskName);
        }

        // Timer control functions
        function startTimerForTask(taskId, taskName) {
            currentTaskId = taskId;
            currentTimerStatus = TimerStatus.RUNNING;
            startTime = Date.now();
            pausedTime = 0;
            
            // Update UI
            document.getElementById('current-task-name').textContent = taskName;
            updateTimerStatus();
            updateTimerButtons();
            
            // Add visual indicator to task
            addTimerOverlay(taskId, '00:00:00', TimerStatus.RUNNING);
            
            // Start timer interval
            timerInterval = setInterval(updateTimerDisplay, 1000);
            
            console.log(`⏱️ Timer started for task: ${taskName}`);
        }

        function pauseTimer() {
            if (currentTimerStatus !== TimerStatus.RUNNING) return;
            
            currentTimerStatus = TimerStatus.PAUSED;
            pausedTime += Date.now() - startTime;
            
            clearInterval(timerInterval);
            updateTimerStatus();
            updateTimerButtons();
            
            // Update overlay
            if (currentTaskId) {
                const currentTime = formatTime(Math.floor(pausedTime / 1000));
                addTimerOverlay(currentTaskId, currentTime, TimerStatus.PAUSED);
            }
            
            console.log('⏸️ Timer paused');
        }

        function resumeTimer() {
            if (currentTimerStatus !== TimerStatus.PAUSED) return;
            
            currentTimerStatus = TimerStatus.RUNNING;
            startTime = Date.now();
            
            updateTimerStatus();
            updateTimerButtons();
            
            // Update overlay
            if (currentTaskId) {
                const currentTime = formatTime(Math.floor(pausedTime / 1000));
                addTimerOverlay(currentTaskId, currentTime, TimerStatus.RUNNING);
            }
            
            timerInterval = setInterval(updateTimerDisplay, 1000);
            
            console.log('▶️ Timer resumed');
        }

        function stopTimer() {
            if (currentTimerStatus === TimerStatus.STOPPED) return;
            
            const totalTime = pausedTime + (currentTimerStatus === TimerStatus.RUNNING ? Date.now() - startTime : 0);
            
            clearInterval(timerInterval);
            
            // Save session if there was actual time
            if (totalTime > 1000) { // Only save if more than 1 second
                saveTimerSession(currentTaskId, totalTime);
            }
            
            // Reset timer state
            currentTimerStatus = TimerStatus.STOPPED;
            removeTimerOverlay(currentTaskId);
            currentTaskId = null;
            startTime = null;
            pausedTime = 0;
            
            // Update UI
            document.getElementById('current-task-name').textContent = 'No task selected';
            document.getElementById('timer-display').textContent = '00:00:00';
            updateTimerStatus();
            updateTimerButtons();
            
            console.log('⏹️ Timer stopped');
        }

        function completeTask() {
            if (currentTimerStatus === TimerStatus.STOPPED) return;
            
            const totalTime = pausedTime + (currentTimerStatus === TimerStatus.RUNNING ? Date.now() - startTime : 0);
            
            clearInterval(timerInterval);
            
            // Save session as completed
            saveTimerSession(currentTaskId, totalTime, true);
            
            // Update overlay to completed status
            if (currentTaskId) {
                const finalTime = formatTime(Math.floor(totalTime / 1000));
                addTimerOverlay(currentTaskId, finalTime, TimerStatus.COMPLETED);
            }
            
            // Reset timer state
            currentTimerStatus = TimerStatus.STOPPED;
            currentTaskId = null;
            startTime = null;
            pausedTime = 0;
            
            // Update UI
            document.getElementById('current-task-name').textContent = 'Task completed!';
            document.getElementById('timer-display').textContent = '00:00:00';
            updateTimerStatus();
            updateTimerButtons();
            
            console.log('✅ Task completed');
        }

        // Save timer session to database
        async function saveTimerSessionToDatabase(session) {
            try {
                const formData = new FormData();
                formData.append('action', 'save_timer_session');
                formData.append('process_id', getCurrentProcessId());
                formData.append('task_id', session.taskId);
                formData.append('task_name', session.taskName);
                formData.append('duration', session.duration);
                formData.append('start_time', session.startTime.toISOString());
                formData.append('end_time', session.endTime.toISOString());
                formData.append('completed', session.completed ? 1 : 0);
                formData.append('session_data', JSON.stringify(session));
                
                const response = await fetch('', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('✅ Timer session saved to database');
                } else {
                    console.error('Failed to save timer session:', result.message);
                }
                
            } catch (error) {
                console.error('Error saving timer session to database:', error);
            }
        }

        // Get current process ID
        function getCurrentProcessId() {
            const selector = document.getElementById('timer-process-select');
            return selector ? selector.value : null;
        }

        // Save timer session
        function saveTimerSession(taskId, duration, completed = false) {
            const session = {
                taskId: taskId,
                taskName: getTaskName(taskId),
                duration: duration,
                startTime: new Date(Date.now() - duration),
                endTime: new Date(),
                completed: completed,
                id: Date.now() + Math.random()
            };
            
            timerSessions.push(session);
            updateTimerHistory();
            updateTimerAnalytics();
            
            // Save to database if connected
            if (!dbError) {
                saveTimerSessionToDatabase(session);
            }
            
            console.log('💾 Timer session saved:', session);
        }

        // Get task name by ID
        function getTaskName(taskId) {
            if (!timerViewer || !taskId) return 'Unknown Task';
            
            try {
                const elementRegistry = timerViewer.get('elementRegistry');
                const element = elementRegistry.get(taskId);
                return element ? (element.businessObject.name || element.id) : 'Unknown Task';
            } catch (error) {
                return 'Unknown Task';
            }
        }

        // Update timer display
        function updateTimerDisplay() {
            if (currentTimerStatus !== TimerStatus.RUNNING) return;
            
            const currentTime = pausedTime + (Date.now() - startTime);
            const timeString = formatTime(Math.floor(currentTime / 1000));
            
            document.getElementById('timer-display').textContent = timeString;
            
            // Update overlay
            if (currentTaskId) {
                addTimerOverlay(currentTaskId, timeString, TimerStatus.RUNNING);
            }
        }

        // Format time in HH:MM:SS
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update timer status display
        function updateTimerStatus() {
            const statusElement = document.getElementById('timer-status');
            statusElement.className = `timer-status ${currentTimerStatus}`;
            
            const statusText = {
                [TimerStatus.STOPPED]: 'Stopped',
                [TimerStatus.RUNNING]: 'Running',
                [TimerStatus.PAUSED]: 'Paused',
                [TimerStatus.COMPLETED]: 'Completed'
            };
            
            statusElement.textContent = statusText[currentTimerStatus];
        }

        // Update timer control buttons
        function updateTimerButtons() {
            const startBtn = document.getElementById('btn-start-timer');
            const pauseBtn = document.getElementById('btn-pause-timer');
            const stopBtn = document.getElementById('btn-stop-timer');
            const completeBtn = document.getElementById('btn-complete-task');
            
            const hasActiveTimer = currentTimerStatus !== TimerStatus.STOPPED;
            const isRunning = currentTimerStatus === TimerStatus.RUNNING;
            const isPaused = currentTimerStatus === TimerStatus.PAUSED;
            
            startBtn.disabled = !currentTaskId || isRunning;
            pauseBtn.disabled = !isRunning;
            stopBtn.disabled = !hasActiveTimer;
            completeBtn.disabled = !hasActiveTimer;
            
            // Update button text based on state
            if (isPaused) {
                startBtn.textContent = '▶️ Resume Timer';
            } else {
                startBtn.textContent = '▶️ Start Timer';
            }
        }

        // Timer overlay management
        function addTimerOverlay(taskId, timeString, status) {
            if (!timerViewer) return;
            
            try {
                removeTimerOverlay(taskId); // Remove existing overlay
                
                const elementRegistry = timerViewer.get('elementRegistry');
                const element = elementRegistry.get(taskId);
                
                if (!element) return;
                
                const gfx = elementRegistry.getGraphics(element);
                if (!gfx) return;
                
                const bounds = gfx.getBoundingClientRect();
                const container = document.getElementById('timer-viewer');
                const containerBounds = container.getBoundingClientRect();
                
                const overlay = document.createElement('div');
                overlay.className = `timer-overlay ${status}`;
                overlay.textContent = timeString;
                overlay.style.position = 'absolute';
                overlay.style.left = `${bounds.left - containerBounds.left + (bounds.width / 2) - 30}px`;
                overlay.style.top = `${bounds.top - containerBounds.top - 25}px`;
                overlay.setAttribute('data-task-id', taskId);
                
                container.style.position = 'relative';
                container.appendChild(overlay);
                
                timerOverlays.set(taskId, overlay);
                
            } catch (error) {
                console.error('Failed to add timer overlay:', error);
            }
        }

        function removeTimerOverlay(taskId) {
            if (timerOverlays.has(taskId)) {
                const overlay = timerOverlays.get(taskId);
                if (overlay && overlay.parentNode) {
                    overlay.parentNode.removeChild(overlay);
                }
                timerOverlays.delete(taskId);
            }
        }

        // Update timer history display
        function updateTimerHistory() {
            const entriesContainer = document.getElementById('timer-entries');
            
            if (timerSessions.length === 0) {
                entriesContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        No timer sessions recorded yet. Click on a task in the process above to start timing!
                    </div>
                `;
                return;
            }
            
            // Sort sessions by end time (most recent first)
            const sortedSessions = [...timerSessions].sort((a, b) => b.endTime - a.endTime);
            
            entriesContainer.innerHTML = sortedSessions.map(session => `
                <div class="timer-entry">
                    <div class="timer-task-name">
                        ${session.taskName}
                        ${session.completed ? '<span style="color: var(--timer-completed); margin-left: 8px;">✅</span>' : ''}
                    </div>
                    <div class="timer-duration">${formatTime(Math.floor(session.duration / 1000))}</div>
                </div>
            `).join('');
        }

        // Update timer analytics
        function updateTimerAnalytics() {
            const totalSessions = timerSessions.length;
            const completedSessions = timerSessions.filter(s => s.completed).length;
            
            // Calculate averages
            let avgTaskTime = 0;
            let totalTimeToday = 0;
            const today = new Date().toDateString();
            
            if (totalSessions > 0) {
                const totalDuration = timerSessions.reduce((sum, session) => sum + session.duration, 0);
                avgTaskTime = totalDuration / totalSessions;
                
                totalTimeToday = timerSessions
                    .filter(session => session.endTime.toDateString() === today)
                    .reduce((sum, session) => sum + session.duration, 0);
            }
            
            // Update analytics display
            document.getElementById('total-sessions').textContent = totalSessions;
            document.getElementById('avg-task-time').textContent = formatTime(Math.floor(avgTaskTime / 1000));
            document.getElementById('total-time-today').textContent = formatTime(Math.floor(totalTimeToday / 1000));
            document.getElementById('active-timers').textContent = currentTimerStatus !== TimerStatus.STOPPED ? 1 : 0;
            
            // Update change indicators
            const todaySessions = timerSessions.filter(s => s.endTime.toDateString() === today).length;
            document.getElementById('sessions-change').textContent = `+${todaySessions} today`;
            document.getElementById('avg-change').textContent = `Based on ${totalSessions} sessions`;
            document.getElementById('